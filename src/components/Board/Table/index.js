/* eslint react/prop-types: 0 */
/* eslint max-len: ["error", { "code": 180,  }] */
import React, { Fragment } from 'react';
import { connect } from 'react-redux';
import { bindActionCreators } from 'redux';
import { getFlights } from '../../../actions';
import { departured } from '../../../helpers/constants';
import { getDate } from '../../../helpers';

import table from './style.css';
import Loader from '../../Loader';

class Table extends React.Component {
  componentDidMount() {
    const { fetchFlights } = this.props;
    fetchFlights(departured);
  }

  render() {
    const { isFetching, error, flights } = this.props;
    return (
      <Fragment>
        {flights && flights.scheduledFlights && (
          <table className={table.wrapper}>
            <thead>
              <tr className={table.labels}>
                <th>–≤—Ä–µ–º—è</th>
                <th>–∞—ç—Ä–æ–ø–æ—Ä—Ç</th>
                <th>–Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞</th>
                <th>—Ç–µ—Ä–º–∏–Ω–∞–ª</th>
                <th>—Å—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody>
              {flights.scheduledFlights.map(flight => (
                <tr align="center" className={table.values} key={flight.referenceCode}>
                  <td>
                    {flights.request.departing
                      ? getDate(flight.departureTime)
                      : getDate(flight.arrivalTime)}
                  </td>
                  <td>
                    {flights.request.departing
                      ? flight.arrivalAirportFsCode
                      : flight.departureAirportFsCode}
                  </td>
                  <td>{`${flight.carrierFsCode} ${flight.flightNumber}`}</td>
                  <td>{flight.departureTerminal || flight.arrivalTerminal}</td>
                  <td>
                    {flight.isCodeshare ? (
                      <span className={table.warning}>–ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>
                    ) : (
                      '–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é'
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
        {error && (
          <div>
            –ò–∑–≤–∏–Ω–∏—Ç–µ! –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
            <span role="img" aria-label="Sadman">
              üòü
            </span>
            {error}
          </div>
        )}
        {isFetching && <Loader />}
      </Fragment>
    );
  }
}

const getFilteredFlights = (flights) => {
  const { searchTerm } = flights;
  const { scheduledFlights } = flights.schedule;

  const filteredFlights = scheduledFlights.filter(
    flight => flight.carrierFsCode.toLowerCase().includes(searchTerm.toLowerCase())
      || flight.flightNumber.includes(searchTerm),
  );
  return searchTerm.length === 0 || !scheduledFlights
    ? flights.schedule
    : {
      ...flights.schedule,
      scheduledFlights: filteredFlights,
    };
};

const mapStateToProps = state => ({
  flights: getFilteredFlights(state.flights),
  isFetching: state.flights.isFetching,
  error: state.flights.error,
});

const mapDispatchToProps = dispatch => bindActionCreators(
  {
    fetchFlights: getFlights,
  },
  dispatch,
);

export default connect(
  mapStateToProps,
  mapDispatchToProps,
)(Table);
